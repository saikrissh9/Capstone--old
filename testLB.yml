# - name: A simple Load Balanced AWS server
#   hosts: localhost 
#   #connection: local
#   gather_facts: False
#   tasks:
#     - name: Create an EC2 instance
#       ec2:
#         aws_access_key: "{{ access_key }}"
#         aws_secret_key: "{{ secret_key }}"
#         key_name: lab
#         region: us-west-1
#         group: lab
#         instance_type: t2.micro
#         image: ami-07b068f843ec78e72
#         wait: yes
#         instance_tags:
#           env: demo
#         count_tag: env
#         exact_count: 1
#         vpc_subnet_id: subnet-31db5c57
#         assign_public_ip: yes
#       register: ec2

#     - name: wait for the servers to appear on the network
#       wait_for: 
#         host: "{{ item.public_dns_name }}" 
#         port: 22 
#         delay: 10
#         state: started
#       with_items: "{{ec2.tagged_instances}}"

#     - name: add server ip addresses to hosts group
#       add_host: hostname={{ item.public_ip }} groupname=launched
#       with_items: "{{ec2.tagged_instances}}"

# - name: webservers (installs nginx ...)
#   hosts: launched
#   remote_user: ubuntu
#   become: true
#   become_method: sudo
#   gather_facts: Truel
#   roles:
#     - web

- name: Create a target group with instance targets
  community.aws.elb_target_group:
    name: mytargetgroup
    aws_access_key: AKIATLVV7HZZWXRO46H5
    aws_secret_key: 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
    region: us-west-1
    protocol: http
    port: 81 
    vpc_id: vpc-cf4297a9
    health_check_protocol: http
    health_check_path: /
    successful_response_codes: "200,250-260"
    # targets:
    #   - Id: "{{ ec2.results[1].instances[0].Id }}"
    #     Port: 80
          #     - Id: i-98765432
          #       Port: 80
    state: present
    wait_timeout: 200
    wait: True

# - name: spin up the load balancer and add the servers to it
#   hosts: 127.0.0.1
#   connection: local
#   gather_facts: False
#   tasks:
#     - name: setup a simple load balancer
#       ec2_elb_lb:
#         name: aws-elb-demo
#         state: present
#         aws_access_key: AKIATLVV7HZZWXRO46H5
#         aws_secret_key: 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
#         region: us-west-1
#         zones:
#           - us-west-1b
#             us-west-1c
#         listeners:
#           - protocol: http
#             load_balancer_port: 80
#             instance_port: 80
#       register: aws-elb-demo

#     - name: add the webservers to the load balancer
#       local_action: ec2_elb
#       args:
#         aws_access_key: AKIATLVV7HZZWXRO46H5
#         aws_secret_key: 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
#         instance_id: "{{ item.id }}"
#         ec2_elbs: aws-elb-demo
#         state: present
#         region: us-west-1
#       with_items: ec2.tagged_instances